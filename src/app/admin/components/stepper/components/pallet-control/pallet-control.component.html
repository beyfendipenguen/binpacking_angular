<form [formGroup]="secondFormGroup">
  <div class="logistics-header">
    <div class="header-icon">
      <mat-icon>inventory_2</mat-icon>
    </div>
    <div class="header-titles">
      <h1>Palet Yerleştirme</h1>
      <p class="header-subtitle">Ürünleri paletlere yerleştirin ve yük dağılımını optimize edin</p>
    </div>
  </div>

  <div class="logistics-dashboard">
    <div class="dashboard-item">
      <div class="dashboard-icon">
        <mat-icon>view_in_ar</mat-icon>
      </div>
      <div class="dashboard-info">
        <span class="dashboard-label">Kalan Alan</span>
        <span class="dashboard-value">{{ remainingArea() }} m²</span>
      </div>
    </div>

    <div class="dashboard-item">
      <div class="dashboard-icon">
        <mat-icon>scale</mat-icon>
      </div>
      <div class="dashboard-info">
        <span class="dashboard-label">Toplam Ağırlık</span>
        <span class="dashboard-value">{{ totalWeight() }} kg</span>
      </div>
    </div>

    <div class="dashboard-item">
      <div class="dashboard-icon">
        <mat-icon>fitness_center</mat-icon>
      </div>
      <div class="dashboard-info">
        <span class="dashboard-label">Kalan Ağırlık</span>
        <span class="dashboard-value">{{ remainingWeight() }} kg</span>
      </div>
    </div>

    <div class="dashboard-item">
      <div class="dashboard-icon">
        <mat-icon>straighten</mat-icon>
      </div>
      <div class="dashboard-info">
        <span class="dashboard-label">Toplam Metre</span>
        <span class="dashboard-value">{{ totalMeter() }} m</span>
      </div>
    </div>
  </div>

  <div class="logistics-container">
    <!-- ÜRÜNLER BÖLÜMÜ -->
    <div class="inventory-section">
      <div class="section-header">
        <mat-icon>category</mat-icon>
        <h2>Envanter</h2>
      </div>
      <div class="search-container">
        <div class="search-input-wrapper">
          <mat-icon class="search-icon">search</mat-icon>

          <input
            matInput
            class="search-input"
            type="text"
            placeholder="Ürün ara..."
            [formControl]="searchControl"
            [matAutocomplete]="auto">

          @if(searchControl.value){
            <button
              mat-icon-button
              class="clear-search"
              (click)="clearSearch()"
              matTooltip="Aramayı temizle">
              <mat-icon>close</mat-icon>
            </button>
          }

          <mat-autocomplete #auto="matAutocomplete" class="search-autocomplete" [displayWith]="displayProductFn.bind(this)">
            <mat-option *ngIf="isSearching" class="loading-indicator">
              <mat-spinner diameter="20"></mat-spinner> Aranıyor...
            </mat-option>

            <ng-container *ngIf="!isSearching">
              <mat-option *ngIf="filteredProducts.length === 0" disabled>
                Sonuç bulunamadı
              </mat-option>
              <mat-option *ngFor="let product of filteredProducts" [value]="product"
                (click)="selectProduct(product)">
                {{ product.name }}
              </mat-option>
            </ng-container>
          </mat-autocomplete>
        </div>
      </div>

      <div cdkDropList #productsList="cdkDropList" id="productsList" [cdkDropListData]="remainingProducts()"
        [cdkDropListConnectedTo]="palletDropListIds()" class="inventory-list"
        (cdkDropListDropped)="dropProductToPallet($event)">
        @for(product of remainingProducts(); track product.id){
        <div class="product-item" cdkDrag (cdkDragStarted)="dragStarted($event)" (cdkDragEnded)="dragEnded()"
          [cdkDragData]="product">

          <div class="product-icon"></div>
          <div class="product-info">
            <span class="product-name">{{ product.name }}</span>
            <div class="product-count-container">
              <input
                class="product-count-input"
                type="number"
                min="1"
                [value]="product.count"
                (change)="updateProductCount(product, $event)"
                (keydown.enter)="updateProductCount(product, $event)">
              <span class="count-label">Adet</span>
            </div>
          </div>

          <div class="split-product-container">
            <input class="mini-split-input" type="number" min="1" [max]="product.count - 1" placeholder="1" #splitInput
              (keydown.enter)="splitProduct(product, splitInput.value ? +splitInput.value : null); splitInput.value = ''"
              matTooltip="Kaç adet ayırmak istiyorsunuz?">

            <button mat-icon-button class="action-button split-button"
              (click)="splitProduct(product, splitInput.value ? +splitInput.value : null); splitInput.value = ''"
              matTooltip="Ürünü böl">
              <mat-icon>content_cut</mat-icon>
            </button>
          </div>
        </div>
        }
        @if(!hasRemainingProduct()){
        <div class="empty-state">
          <mat-icon>done_all</mat-icon>
          <p>Tüm ürünler paletlere yerleştirildi.</p>
        </div>
        }
      </div>
    </div>

    <!-- PAKETLER BÖLÜMÜ -->
    <div class="packages-section">
      <div class="section-header with-action">
        <div class="header-content-inline">
          <div class="header-title-section">
            <mat-icon>view_quilt</mat-icon>
            <h2>Paletleme Alanı</h2>
          </div>

          <!-- Palet İstatistikleri - Aynı satırda -->
          <div class="pallet-stats-inline">
            <div class="stat-item heaviest">
              <mat-icon>fitness_center</mat-icon>
              <div class="stat-info">
                <span class="stat-label">En Ağır</span>
                <span class="stat-value">{{ heaviestPalletWeight() }} kg</span>
              </div>
            </div>

            <div class="stat-item lightest">
              <mat-icon>feather</mat-icon>
              <div class="stat-info">
                <span class="stat-label">En Hafif</span>
                <span class="stat-value">{{ lightestPalletWeight() }} kg</span>
              </div>
            </div>

            <div class="stat-item average">
              <mat-icon>analytics</mat-icon>
              <div class="stat-info">
                <span class="stat-label">Ortalama</span>
                <span class="stat-value">{{ averagePalletWeight() }} kg</span>
              </div>
            </div>
          </div>
        </div>

        <button mat-button class="clear-button" (click)="removeAllPackage()" matTooltip="Tüm paketleri temizle">
          <mat-icon>delete_sweep</mat-icon>
          <span>Temizle</span>
        </button>
      </div>

      <div class="packages-grid">
        @for(package of uiPackages(); track package.id){
        <div class="package-card">
          <div class="package-header">
            <div class="package-title">
              <mat-icon>inbox</mat-icon>
              <span>Palet {{package.name}}</span>
            </div>
            <div class="package-actions">
              <button mat-icon-button class="small-action" matTooltip="Paketi çıkar" (click)="removePackage(package)">
                <mat-icon>close</mat-icon>
              </button>
            </div>
          </div>

          <!-- Paket içeriği -->
          <div cdkDropList [id]="package.id" [cdkDropListData]="[]" [cdkDropListConnectedTo]="['availablePalletsList']"
            class="package-dropzone" (cdkDropListDropped)="dropPalletToPackage($event)">

            <!-- Eğer paket içinde palet varsa göster -->
            @if(package.pallet){
            <div class="pallet-container">
              <div class="pallet-header">
                <div class="pallet-title">
                  <div class="pallet-icon"></div>
                  <span>{{ package.pallet.name }}</span>
                </div>
                <button mat-icon-button class="small-action" (click)="removePalletFromPackage(package)"
                  matTooltip="Paleti çıkar">
                  <mat-icon>close</mat-icon>
                </button>
              </div>

              <!-- Palet içindeki ürünler -->
              <div cdkDropList [id]="package.pallet.id" [cdkDropListData]="package.products"
                [cdkDropListConnectedTo]="palletDropListIds()" class="pallet-content"
                (cdkDropListDropped)="dropProductToPallet($event)">

                <div class="pallet-item" *ngFor="let product of package.products; let j = index" cdkDrag
                  [cdkDragData]="product" (cdkDragStarted)="dragStarted($event)" (cdkDragEnded)="dragEnded()">

                  <div class="product-icon small"></div>
                  <div class="product-info">
                    <span class="product-name">{{ product.name }}</span>
                    <span class="product-count">{{ product.count }} Adet</span>
                  </div>
                  <div class="button-container">

                  <button  mat-icon-button class="action-button" (click)="addUiProduct(product)"
                    matTooltip="ekle">
                    <mat-icon>add</mat-icon>
                  </button>
                  <button mat-icon-button class="action-button" (click)="removeProductFromPackage(package, j)"
                    matTooltip="Ürünü çıkar">
                    <mat-icon>close</mat-icon>
                  </button>
                  </div>
                </div>

                <!-- Boş palet mesajı -->
                @if(package.products.length === 0){
                <div class="empty-state">
                  <mat-icon>drag_indicator</mat-icon>
                  <p>Bu palete ürün sürükleyin</p>
                </div>
                }
              </div>

              <div class="pallet-footer">
                <div class="pallet-metrics">
                  <div class="metric">
                    <mat-icon>scale</mat-icon>
                    <span>{{ packageTotalWeight(package) }} kg</span>
                  </div>
                  <div class="metric">
                    <mat-icon>straighten</mat-icon>
                    <span>{{ package.totalMeter() }} m</span>
                  </div>
                  <div class="metric efficiency-metric">
                    <mat-icon>analytics</mat-icon>
                    <div class="efficiency-container">
                      <span class="efficiency-value">{{ getPalletFillPercentage(package.pallet, package.products)
                        }}%</span>
                      <div class="efficiency-bar">
                        <div class="efficiency-fill"
                          [style.width.%]="getPalletFillPercentage(package.pallet, package.products)"
                          [class.high-efficiency]="getPalletFillPercentage(package.pallet, package.products) >= 80"
                          [class.medium-efficiency]="getPalletFillPercentage(package.pallet, package.products) >= 50 && getPalletFillPercentage(package.pallet, package.products) < 80"
                          [class.low-efficiency]="getPalletFillPercentage(package.pallet, package.products) < 50">
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>
            }
            <!-- Boş paket mesajı -->
            @if(!package.pallet){
            <div class="empty-state">
              <mat-icon>add_box</mat-icon>
              <p>Palet sürükleyin</p>
            </div>
            }
          </div>
        </div>
        }
      </div>
    </div>

    <!-- PALETLER BÖLÜMÜ -->
    <div class="pallets-section">
      <div class="section-header">
        <mat-icon>view_module</mat-icon>
        <h2>Palet Tipleri</h2>
      </div>

      <div cdkDropList #palletsList="cdkDropList" id="availablePalletsList" [cdkDropListData]="availablePallets()"
        [cdkDropListConnectedTo]="packageDropListIds()" class="pallets-list"
        (cdkDropListDropped)="dropPalletToPackage($event)">
        @for(pallet of availablePallets(); track pallet.id){
        <div class="pallet-item" cdkDrag>
          <div class="pallet-base-icon"></div>
          <span class="pallet-name">{{ pallet.name }}</span>
        </div>
        }

        @if(availablePallets().length === 0){
        <div class="empty-state">
          <mat-icon>info</mat-icon>
          <p>Henüz palet bulunmamaktadır.</p>
        </div>
        }
      </div>
    </div>
  </div>

  <div class="navigation-controls">
    <div class="stepper-controls">
      <button mat-raised-button class="prev-button" matStepperPrevious>
        <mat-icon>arrow_back</mat-icon>
        <span>Geri</span>
      </button>

      <button mat-raised-button class="next-button" matStepperNext (click)="submitForm()">
        <span>{{this.isDirtySignal() ? 'Kaydet' : 'ileri'}}</span>
        <mat-icon>arrow_forward</mat-icon>
      </button>
    </div>
  </div>
</form>

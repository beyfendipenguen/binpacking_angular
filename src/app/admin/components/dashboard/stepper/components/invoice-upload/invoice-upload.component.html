<div class="logistics-container">
  <!-- Page Header -->
  <div class="logistics-header">
    <div class="header-icon">
      <mat-icon>assignment</mat-icon>
    </div>
    <div class="header-titles">
      <h1>İhracat Sipariş Bildirimi</h1>
      <p class="header-subtitle">
        Siparişlerin detaylarını yönetin ve takip edin
      </p>
    </div>
  </div>

  <!-- Empty State Card -->
  <div class="logistics-card" *ngIf="(!order || !order.id) && !isLoading">
    <div class="empty-state">
      <div class="empty-icon">
        <mat-icon>description</mat-icon>
      </div>
      <h3>Sipariş Bilgisi Bulunamadı</h3>
      <p>
        Mevcut bir sipariş bilgisi bulunmuyor. Excel dosyası yükleyebilir veya
        manuel olarak sipariş detayı ekleyebilirsiniz.
      </p>

      <div class="action-options">
        <button
          mat-raised-button
          class="action-button"
          (click)="createOrderDetail()"
        >
          <mat-icon>add</mat-icon>
          <span>Manuel Giriş</span>
        </button>

        <div class="divider">
          <span>veya</span>
        </div>

        <div class="file-upload-container">
          <button
            mat-raised-button
            class="action-button secondary"
            (click)="fileInput.click()"
            [disabled]="excelUpload"
          >
            <mat-icon>file_upload</mat-icon>
            <span>{{ file?.name || "Excel Dosyası Seç" }}</span>
          </button>
          <input
            (change)="onFileSelected($event)"
            #fileInput
            type="file"
            accept=".pdf,.xls,.xlsx"
            hidden
          />

          <button
            *ngIf="file"
            mat-raised-button
            class="upload-button"
            [disabled]="!file || excelUpload"
            (click)="uploadFile()"
          >
            <mat-icon>cloud_upload</mat-icon>
            <span>İçeri Aktar</span>
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- Loading Indicator -->
  <div class="loading-container" *ngIf="isLoading ">
    <div class="loading-content">
      <div class="animated-icon">
        <mat-icon>local_shipping</mat-icon>
        <div class="loading-dots">
          <span></span>
          <span></span>
          <span></span>
        </div>
      </div>
      <p>Sipariş verileri yükleniyor...</p>
    </div>
  </div>

  <!-- Order Details Dashboard -->
  <div *ngIf="(order && order.id) && !isLoading" class="details-section">
    <!-- Order Summary -->
    <div class="dashboard-panel">
      <!-- Sipariş Tarihi -->
      <div class="dashboard-item">
        <div class="dashboard-icon">
          <mat-icon>event</mat-icon>
        </div>
        <div class="dashboard-info">
          <span class="dashboard-label">Sipariş Tarihi</span>
          <div class="dashboard-value-container">
            <mat-form-field class="edit-field" appearance="outline">
              <input
                matInput
                [matDatepicker]="picker"
                [(ngModel)]="order.date"
                (ngModelChange)="onOrderFieldChange('date', $event)"
                placeholder="Tarih seçin"
                required
              />
              <mat-datepicker-toggle
                matSuffix
                [for]="picker"
              ></mat-datepicker-toggle>
              <mat-datepicker #picker></mat-datepicker>
              <mat-error *ngIf="!order?.date">
                Sipariş tarihi zorunludur
              </mat-error>
            </mat-form-field>
          </div>
        </div>
      </div>

      <!-- Müşteri -->
      <div class="dashboard-item">
        <div class="dashboard-icon">
          <mat-icon>business</mat-icon>
        </div>
        <div class="dashboard-info">
          <span class="dashboard-label">Müşteri</span>
          <div class="dashboard-value-container">
            <mat-form-field class="edit-field" appearance="outline">
              <mat-select
                [(ngModel)]="order.company_relation"
                (selectionChange)="onCompanyChange($event.value)"
                placeholder="Müşteri seçin"
                [compareWith]="compareCompanies"
                required
              >
                <mat-option
                  *ngFor="let company of targetCompanies"
                  [value]="company"
                >
                  {{ company.target_company_name }}
                </mat-option>
              </mat-select>
              <mat-error *ngIf="!order?.company_relation">
                Müşteri seçimi zorunludur
              </mat-error>
            </mat-form-field>
          </div>
        </div>
      </div>

      <!-- Tır Bilgisi -->
      <div class="dashboard-item">
        <div class="dashboard-icon">
          <mat-icon>local_shipping</mat-icon>
        </div>
        <div class="dashboard-info">
          <span class="dashboard-label">Tır</span>
          <div class="dashboard-value-container">
            <mat-form-field class="edit-field" appearance="outline">
              <mat-select
                [(ngModel)]="order.truck"
                (selectionChange)="onTruckChange($event.value)"
                placeholder="Tır seçin"
                [compareWith]="compareObjects"
                required
              >
                <mat-option *ngFor="let truck of trucks" [value]="truck">
                  {{ truck.name }}
                </mat-option>
              </mat-select>
              <mat-error *ngIf="!order?.truck">
                Tır seçimi zorunludur
              </mat-error>
            </mat-form-field>
          </div>
        </div>
      </div>

      <!-- Ağırlık Tipi -->
      <div class="dashboard-item">
        <div class="dashboard-icon">
          <mat-icon>category</mat-icon>
        </div>
        <div class="dashboard-info">
          <span class="dashboard-label">Ağırlık Tipi</span>
          <div class="dashboard-value-container">
            <mat-form-field class="edit-field" appearance="outline">
              <mat-select
                [(ngModel)]="order.weight_type"
                (selectionChange)="onWeightTypeChange($event.value)"
                placeholder="Ağırlık tipi seçin"
                [compareWith]="compareWeightTypes"
                required
              >
                <mat-option value="eco">Eco</mat-option>
                <mat-option value="std">Std</mat-option>
                <mat-option value="pre">Pre</mat-option>
              </mat-select>
              <mat-error *ngIf="!order?.weight_type">
                Ağırlık tipi seçimi zorunludur
              </mat-error>
            </mat-form-field>
          </div>
        </div>
      </div>
    </div>

    <!-- Order Details Table -->
    <div class="logistics-card">
      <div class="section-header with-action">
        <div class="header-title">
          <mat-icon>list_alt</mat-icon>
          <h2>Sipariş Detayları</h2>
        </div>
      </div>

      <div class="table-container">
        <app-generic-table
          [externalData]="orderDetails"
          [externalTotalCount]="orderDetails.length"
          [displayedColumns]="displayedColumns"
          [filterableColumns]="filterableColumns"
          [nestedDisplayColumns]="nestedDisplayColumns"
          [parentId]="order.id"
          [useParentId]="true"
          [parentIdFieldName]="'order_id'"
          [title]="''"
          [showRowNumbers]="true"
          (addClick)="createOrderDetail()"
          (externalDataUpdate)="updateOrderDetail($event)"
          (externalDataDelete)="deleteOrderDetail($event)"
          [excludeFields]="excludeFields"
        >
        </app-generic-table>
      </div>

      <div
        class="summary-footer"
        *ngIf="orderDetails && orderDetails.length > 0"
      >
        <div class="summary-content">
          <div class="summary-metrics">
            <div class="metric">
              <mat-icon>inventory_2</mat-icon>
              <span>{{ orderDetails.length }} Kalem</span>
            </div>
            <div class="metric">
              <mat-icon>scale</mat-icon>
              <span>{{ totalWeight.toFixed(2) }} kg</span>
            </div>
          </div>
          <button
            mat-raised-button
            class="save-button"
            [disabled]="!isFormValid() || isLoading"
            (click)="submit()"
          >
            <mat-icon>save</mat-icon>
            <span>Kaydet</span>
          </button>
          <div class="status-badge">
            <span class="status-dot active"></span>
            <span>Aktif</span>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Navigation Controls -->
  <div class="navigation-controls">
    <button
      mat-raised-button
      class="next-button"
      matStepperNext
      [disabled]="!order || !isFormValid()"
    >
      <span>Sonraki Adım</span>
      <mat-icon>arrow_forward</mat-icon>
    </button>
  </div>
</div>

<div class="logistics-result-screen">
  <!-- Enhanced Controls Container -->
  <div class="controls-container">
    <div class="action-buttons">
      <button mat-raised-button class="calculate-button" [disabled]="isLoading" (click)="calculateBinpacking()">
        <mat-icon>play_arrow</mat-icon>
        {{ (isLoading ? 'RESULT_STEP.PROCESSING' : 'RESULT_STEP.RUN_OPTIMIZATION') | translate }}
      </button>
    </div>

    <!-- Enhanced View Controls -->
    @if (hasResultsSignal() ) {
    <div class="view-controls">
      <button class="view-button" [class.active]="currentViewTypeSignal() === 'front'" [disabled]="isLoading"
        (click)="threeJSComponent.setView('front')">
        <mat-icon>view_agenda</mat-icon>
        <span>{{ 'RESULT_STEP.FRONT' | translate }}</span>
      </button>

      <button class="view-button" [class.active]="currentViewTypeSignal() === 'side'" [disabled]="isLoading"
        (click)="threeJSComponent.setView('side')">
        <mat-icon>view_sidebar</mat-icon>
        <span>{{ 'RESULT_STEP.SIDE' | translate }}</span>
      </button>

      <button class="view-button" [class.active]="currentViewTypeSignal() === 'top'" [disabled]="isLoading"
        (click)="threeJSComponent.setView('top')">
        <mat-icon>view_comfy</mat-icon>
        <span>{{ 'RESULT_STEP.TOP' | translate }}</span>
      </button>

      <button class="view-button" [class.active]="currentViewTypeSignal() === 'isometric'" [disabled]="isLoading"
        (click)="threeJSComponent.resetView()">
        <mat-icon>view_in_ar</mat-icon>
        <span>3D</span>
      </button>
    </div>
    }
  </div>

  <!-- Enhanced Visualization Container -->
  <div class="visualization-container">

    <!-- Visualization Overlay (No Results) -->
    @if (!hasResultsSignal() && !isLoading) {
    <div class="visualization-overlay">
      <div class="overlay-content">
        <mat-icon class="overlay-icon">local_shipping</mat-icon>
        <h3>{{ 'RESULT_STEP.VISUALIZATION_READY' | translate }}</h3>
        <p>
          {{ 'RESULT_STEP.VISUALIZATION_MESSAGE' | translate }}
        </p>
        <div class="quick-stats">
          <div class="quick-stat">
            <mat-icon class="stat-icon">3d_rotation</mat-icon>
            <span>{{ 'RESULT_STEP.REALTIME_3D' | translate }}</span>
          </div>
          <div class="quick-stat">
            <mat-icon class="stat-icon">touch_app</mat-icon>
            <span>{{ 'RESULT_STEP.DRAG_DROP' | translate }}</span>
          </div>
          <div class="quick-stat">
            <mat-icon class="stat-icon">sync_alt</mat-icon>
            <span>{{ 'RESULT_STEP.LIVE_DATA_SYNC' | translate }}</span>
          </div>
        </div>
      </div>
    </div>
    }

    <!-- ENHANCED: ThreeJS Truck Visualization Component with NEW dataChanged event -->
    @if (hasResultsSignal() && !hasThreeJSError) {
    <app-threejs-truck-visualization #threeJSComponent (error)="onThreeJSError($event)">
    </app-threejs-truck-visualization>
    }

    <!-- Enhanced Three.js Error Display -->
    @if (hasThreeJSError) {
    <div class="threejs-error-display">
      <div class="error-content">
        <mat-icon class="error-icon">error_outline</mat-icon>
        <h3>{{ 'RESULT_STEP.VISUALIZATION_ERROR' | translate }}</h3>
        <p>
          {{ 'RESULT_STEP.VISUALIZATION_ERROR_MESSAGE' | translate }}
        </p>
        <button mat-raised-button color="primary" (click)="hasThreeJSError = false">
          <mat-icon>refresh</mat-icon>{{ 'RESULT_STEP.TRY_AGAIN' | translate }}</button>
      </div>
    </div>
    }
  </div>

  <!-- Enhanced Report Files Container -->
  @if (reportFilesSignal() && reportFilesSignal().length > 0) {
  <div class="report-files-container">
    <div class="report-files-header">
      <mat-icon>description</mat-icon>
      <span>{{ 'RESULT_STEP.REPORT_FILES' | translate }}</span>
      <div class="file-count">{{ reportFilesSignal().length }}</div>

      <!-- ✅ NEW: Unsaved Changes Badge -->
      @if (isDirtySignal()) {
      <div class="unsaved-badge" [title]="'RESULT_STEP.UNSAVED_CHANGES' | translate">
        <mat-icon>warning</mat-icon>
        <span>{{ 'RESULT_STEP.CHANGES_NOT_SAVED' | translate }}</span>
      </div>
      }
    </div>

    <div class="report-files-list">
      @for (file of reportFilesSignal(); track trackByFileId($index, file)) {
      <div class="report-file-item" [class.has-changes]="isDirtySignal()">
        <div class="file-icon" [class]="'file-type-' + getFileIcon(file.type)">
          <mat-icon>{{ getFileIcon(file.type) }}</mat-icon>
        </div>
        <div class="file-info">
          <!-- ✅ CHANGED: Click handler ekle, href kaldır -->
          <a class="file-link" (click)="onFileClick($event, file)" [class.saving]="isDirtySignal()"
            style="cursor: pointer;">
            <span class="file-name">{{ file.name }}</span>

            <!-- ✅ NEW: Icon değişimi -->
            @if (!isDirtySignal()) {
            <mat-icon class="download-icon">download</mat-icon>
            }
            @if (isDirtySignal()) {
            <mat-icon class="save-icon">save</mat-icon>
            }
          </a>
        </div>
      </div>
      }

      @if (reportFilesSignal().length === 0) {
      <div class="empty-files">
        <mat-icon>folder_open</mat-icon>
        <span>{{ 'RESULT_STEP.NO_REPORT_FILES' | translate }}</span>
      </div>
      }
    </div>

    <!-- ✅ NEW: Info Message -->
    @if (isDirtySignal()) {
    <div class="auto-save-info">
      <mat-icon>info</mat-icon>
      <span>{{ 'RESULT_STEP.AUTO_SAVE_MESSAGE' | translate }}</span>
    </div>
    }
  </div>
  }

  <button mat-button class="prev-button" (click)="goPreviousStep()">
    <mat-icon>arrow_back</mat-icon>
    <span>{{ 'COMMON.BACK' | translate }}</span>
  </button>

  <button mat-button class="complete-order-button" (click)="completeShipment()"
    [disabled]="!hasResultsSignal() && isDirtySignal()">
    <mat-icon>check_circle</mat-icon>
    <span>{{ 'RESULT_STEP.COMPLETE_SHIPMENT' | translate }}</span>
  </button>
</div>

<div class="logistics-result-screen">
  <!-- Enhanced Controls Container -->
  <div class="controls-container">
    <div class="action-buttons">
      <button mat-raised-button class="calculate-button" [disabled]="isLoading" (click)="calculateBinpacking()">
        <mat-icon>play_arrow</mat-icon>
        {{ isLoading ? "İşlem Devam Ediyor..." : "Optimizasyonu Çalıştır" }}
      </button>
    </div>

    <!-- Enhanced View Controls -->
    @if (hasResults ) {
    <div class="view-controls">
      <button class="view-button" [class.active]="currentViewType === 'front'" [disabled]="isLoading"
        (click)="threeJSComponent.setView('front')">
        <mat-icon>view_agenda</mat-icon>
        <span>Ön</span>
      </button>

      <button class="view-button" [class.active]="currentViewType === 'side'" [disabled]="isLoading"
        (click)="threeJSComponent.setView('side')">
        <mat-icon>view_sidebar</mat-icon>
        <span>Yan</span>
      </button>

      <button class="view-button" [class.active]="currentViewType === 'top'" [disabled]="isLoading"
        (click)="threeJSComponent.setView('top')">
        <mat-icon>view_comfy</mat-icon>
        <span>Üst</span>
      </button>

      <button class="view-button" [class.active]="currentViewType === 'isometric'" [disabled]="isLoading"
        (click)="threeJSComponent.resetView()">
        <mat-icon>view_in_ar</mat-icon>
        <span>3D</span>
      </button>
    </div>
    }
  </div>

  <!-- Enhanced Visualization Container -->
  <div class="visualization-container">

    <!-- Visualization Overlay (No Results) -->
    @if (!hasResults && !isLoading) {
    <div class="visualization-overlay">
      <div class="overlay-content">
        <mat-icon class="overlay-icon">local_shipping</mat-icon>
        <h3>Görselleştirme Hazır</h3>
        <p>
          Gelişmiş tır yükleme optimizasyonunu çalıştırdıktan sonra burada
          etkileşimli 3D görselleştirmeyi görebilirsiniz.
        </p>
        <div class="quick-stats">
          <div class="quick-stat">
            <mat-icon class="stat-icon">3d_rotation</mat-icon>
            <span>Gerçek Zamanlı 3D</span>
          </div>
          <div class="quick-stat">
            <mat-icon class="stat-icon">touch_app</mat-icon>
            <span>Drag & Drop</span>
          </div>
          <div class="quick-stat">
            <mat-icon class="stat-icon">sync_alt</mat-icon>
            <span>Canlı Veri Senkronizasyonu</span>
          </div>
        </div>
      </div>
    </div>
    }

    <!-- ENHANCED: ThreeJS Truck Visualization Component with NEW dataChanged event -->
    @if (hasResults && !hasThreeJSError) {
    <app-threejs-truck-visualization #threeJSComponent [weightCalculationDepth]="3000" [showWeightDisplay]="true"
      [piecesData]="piecesData" [showHelp]="true" (error)="onThreeJSError($event)">
    </app-threejs-truck-visualization>
    }

    <!-- Enhanced Three.js Error Display -->
    @if (hasThreeJSError) {
    <div class="threejs-error-display">
      <div class="error-content">
        <mat-icon class="error-icon">error_outline</mat-icon>
        <h3>3D Görselleştirme Hatası</h3>
        <p>
          3D görselleştirme yüklenirken bir sorun oluştu. Lütfen sayfayı
          yenileyin veya tarayıcınızın WebGL desteğini kontrol edin.
        </p>
        <button mat-raised-button color="primary" (click)="hasThreeJSError = false">
          <mat-icon>refresh</mat-icon>
          Tekrar Dene
        </button>
      </div>
    </div>
    }
  </div>

  <!-- Enhanced Report Files Container -->
  @if (reportFiles && reportFiles.length > 0) {
  <div class="report-files-container">
    <div class="report-files-header">
      <mat-icon>description</mat-icon>
      <span>Rapor Dosyaları</span>
      <div class="file-count">{{ reportFiles.length }}</div>

      <!-- ✅ NEW: Unsaved Changes Badge -->
      @if (isDirtySignal()) {
      <div class="unsaved-badge" title="Kaydedilmemiş değişiklikler var">
        <mat-icon>warning</mat-icon>
        <span>Değişiklikler Kaydedilmedi</span>
      </div>
      }
    </div>

    <div class="report-files-list">
      @for (file of reportFiles; track trackByFileId($index, file)) {
      <div class="report-file-item" [class.has-changes]="isDirtySignal()">
        <div class="file-icon" [class]="'file-type-' + getFileIcon(file.file_type)">
          <mat-icon>{{ getFileIcon(file.file_type) }}</mat-icon>
        </div>
        <div class="file-info">
          <!-- ✅ CHANGED: Click handler ekle, href kaldır -->
          <a class="file-link" (click)="onFileClick($event, file)" [class.saving]="isDirtySignal()"
            style="cursor: pointer;">
            <span class="file-name">{{ file.name }}</span>
            @if (file.file_size) {
            <span class="file-size">
              {{ formatFileSize(file.file_size) }}
            </span>
            }

            <!-- ✅ NEW: Icon değişimi -->
            @if (!isDirtySignal()) {
            <mat-icon class="download-icon">download</mat-icon>
            }
            @if (isDirtySignal()) {
            <mat-icon class="save-icon">save</mat-icon>
            }
          </a>
        </div>
      </div>
      }

      @if (reportFiles.length === 0) {
      <div class="empty-files">
        <mat-icon>folder_open</mat-icon>
        <span>Henüz rapor dosyası oluşturulmadı</span>
      </div>
      }
    </div>

    <!-- ✅ NEW: Info Message -->
    @if (isDirtySignal()) {
    <div class="auto-save-info">
      <mat-icon>info</mat-icon>
      <span>Dosyaya tıkladığınızda değişiklikler otomatik kaydedilecek</span>
    </div>
    }
  </div>
  }

  <!-- Enhanced Navigation Controls -->
  <div class="navigation-controls">
    <div class="stepper-controls">
      <button (click)="goPreviousStep()" mat-raised-button class="prev-button">
        <mat-icon>arrow_back</mat-icon>
        <span>Geri</span>
      </button>

      <button mat-raised-button class="next-button" [disabled]="!hasResults && isDirtySignal()"
        (click)="completeShipment()">
        <mat-icon>check_circle</mat-icon>
        Sevkiyatı Tamamla
      </button>
    </div>
  </div>
</div>

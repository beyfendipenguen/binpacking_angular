<div class="logistics-container">
  <!-- Page Header -->
  <div class="logistics-header">
    <div class="header-icon">
      <mat-icon>assignment</mat-icon>
    </div>
    <div class="header-titles">
      <h1>{{ 'INVOICE_UPLOAD.TITLE' | translate }}</h1>
      <p class="header-subtitle">{{ 'INVOICE_UPLOAD.SUBTITLE' | translate }}</p>
    </div>
  </div>

  <!-- Empty State Card -->
  @if(!orderSignal() ){
  <div class="logistics-card">
    <!-- Template Info Button - Sağ üst köşe -->
    <button mat-icon-button class="template-info-floating" (click)="downloadTemplate()"
      [matTooltip]="'INVOICE_UPLOAD.DOWNLOAD_TEMPLATE' | translate" matTooltipPosition="left">
      <mat-icon>info</mat-icon>
      @if(showMessageBalloon()) {
      <div class="message-balloon">
        <div class="balloon-content">{{ 'INVOICE_UPLOAD.CLICK_TO_DOWNLOAD' | translate }}</div>
        <div class="balloon-arrow"></div>
      </div>
      }
    </button>

    <div class="empty-state">
      <div class="empty-icon">
        <mat-icon>description</mat-icon>
      </div>
      <h3>{{ 'INVOICE_UPLOAD.NO_ORDER_INFO' | translate }}</h3>
      <p>
        {{ 'INVOICE_UPLOAD.NO_ORDER_MESSAGE' | translate }}
      </p>

      <div class="action-options">
        <button mat-raised-button class="action-button" (click)="createOrder()">
          <mat-icon>add</mat-icon>
          <span>{{ 'INVOICE_UPLOAD.MANUAL_ENTRY' | translate }}</span>
        </button>

        <div class="divider">
          <span>{{ 'INVOICE_UPLOAD.OR' | translate }}</span>
        </div>

        <div class="file-upload-container">
          <button mat-raised-button class="action-button secondary" (click)="fileInput.click()">
            <mat-icon>file_upload</mat-icon>
            <span>{{ file?.name || 'INVOICE_UPLOAD.SELECT_EXCEL' | translate}}</span>
          </button>
          <input (change)="onFileSelected($event)" #fileInput type="file" accept=".xlsx" hidden />
        </div>
      </div>
    </div>
  </div>
  }
  <!-- Order Details Dashboard -->
  @if (orderSignal()) {
  <div class="details-section">
    <!-- Order Summary -->
    <div class="dashboard-panel">
      <!-- Sipariş Tarihi -->
      <div class="dashboard-item">
        <div class="dashboard-icon">
          <mat-icon>event</mat-icon>
        </div>
        <div class="dashboard-info">
          <span class="dashboard-label">{{ 'INVOICE_UPLOAD.ORDER_DATE' | translate }}</span>
          <div class="dashboard-value-container">
            <mat-form-field class="edit-field" appearance="outline">
              <input readonly matInput [matDatepicker]="picker" [value]="orderSignal()?.date"
                (dateChange)="onOrderFieldChange('date', $event.value)" [placeholder]="'INVOICE_UPLOAD.SELECT_DATE' | translate" required />
              <mat-datepicker-toggle matSuffix [for]="picker"></mat-datepicker-toggle>
              <mat-datepicker #picker></mat-datepicker>
              @if(!orderSignal()?.date){
              <mat-error>{{ 'INVOICE_UPLOAD.ORDER_DATE_REQUIRED' | translate }}</mat-error>}
            </mat-form-field>
          </div>
        </div>
      </div>

      <!-- Müşteri -->
      <div class="dashboard-item">
        <div class="dashboard-icon">
          <mat-icon>business</mat-icon>
        </div>
        <div class="dashboard-info">
          <span class="dashboard-label">{{ 'INVOICE_UPLOAD.CUSTOMER' | translate }}</span>
          <div class="dashboard-value-container">
            <mat-form-field class="edit-field" appearance="outline">
              <mat-select [value]="orderSignal()?.company_relation" (selectionChange)="onCompanyChange($event.value)"
                [placeholder]="'INVOICE_UPLOAD.SELECT_CUSTOMER' | translate" [compareWith]="compareCompanies" required>
                @for (company of targetCompanies; track company.id) {
                <mat-option [value]="company">
                  {{ company.target_company_name }} </mat-option>}
              </mat-select>
              @if(!orderSignal()?.company_relation){
              <mat-error>{{ 'INVOICE_UPLOAD.CUSTOMER_REQUIRED' | translate }}</mat-error>}
            </mat-form-field>
          </div>
        </div>
      </div>

      <!-- Tır Bilgisi -->
      <div class="dashboard-item">
        <div class="dashboard-icon">
          <mat-icon>local_shipping</mat-icon>
        </div>
        <div class="dashboard-info">
          <span class="dashboard-label">{{ 'INVOICE_UPLOAD.TRUCK' | translate }}</span>
          <div class="dashboard-value-container">
            <mat-form-field class="edit-field" appearance="outline">
              <mat-select [value]="orderSignal()?.truck" (selectionChange)="onTruckChange($event.value)"
                [placeholder]="'INVOICE_UPLOAD.SELECT_TRUCK' | translate" [compareWith]="compareObjects" required>
                @for(truck of trucks; track truck.id){
                <mat-option [value]="truck"> {{ truck.name }} </mat-option>}
              </mat-select>
              @if(!orderSignal()?.truck){
              <mat-error>{{ 'INVOICE_UPLOAD.TRUCK_REQUIRED' | translate }}</mat-error>}
            </mat-form-field>
          </div>
        </div>
      </div>

      <!-- Ağırlık Tipi -->
      <div class="dashboard-item">
        <div class="dashboard-icon">
          <mat-icon>category</mat-icon>
        </div>
        <div class="dashboard-info">
          <span class="dashboard-label">{{ 'INVOICE_UPLOAD.WEIGHT_TYPE' | translate }}</span>
          <div class="dashboard-value-container">
            <mat-form-field class="edit-field" appearance="outline">
              <mat-select [value]="orderSignal()?.weight_type" (selectionChange)="onWeightTypeChange($event.value)"
                [placeholder]="'INVOICE_UPLOAD.SELECT_WEIGHT_TYPE' | translate" [compareWith]="compareWeightTypes" required>
                <mat-option value="eco">Eco</mat-option>
                <mat-option value="std">Std</mat-option>
                <mat-option value="pre">Pre</mat-option>
              </mat-select>
              @if(!orderSignal()?.weight_type) {
              <mat-error>{{ 'INVOICE_UPLOAD.WEIGHT_TYPE_REQUIRED' | translate }}</mat-error>}
            </mat-form-field>
          </div>
        </div>
      </div>

      <!-- Maksimum Sıra Adedi -->
      <div class="dashboard-item">
        <div class="dashboard-icon">
          <mat-icon>layers</mat-icon>
        </div>
        <div class="dashboard-info">
          <span class="dashboard-label">{{ 'INVOICE_UPLOAD.MAX_STACK_COUNT' | translate }}</span>
          <div class="dashboard-value-container">
            <div class="units-input-container">
              <!-- Azaltma butonu -->
              <button mat-icon-button (click)="onUnitsDecrease()" [disabled]="isMinimumUnits()" type="button"
                class="unit-button">
                <mat-icon>remove</mat-icon>
              </button>

              <!-- Input alanı - FormControl'e bağlı -->
              <mat-form-field class="units-field" appearance="outline">
                <input matInput type="number" [formControl]="unitsControl" readonly min="1" step="1"
                  [placeholder]="'INVOICE_UPLOAD.STACK_COUNT' | translate" />
              </mat-form-field>

              <!-- Artırma butonu -->
              <button mat-icon-button (click)="onUnitsIncrease()" type="button" class="unit-button">
                <mat-icon>add</mat-icon>
              </button>
            </div>
          </div>
        </div>
      </div>

      <!-- Tır Ağırlık Limiti -->
      <div class="dashboard-item">
        <div class="dashboard-icon">
          <mat-icon>scale</mat-icon>
        </div>
        <div class="dashboard-info">
          <span class="dashboard-label">{{ 'INVOICE_UPLOAD.TRUCK_WEIGHT_LIMIT' | translate }}</span>
          <div class="dashboard-value-container">
            <mat-form-field class="edit-field" appearance="outline">
              <input matInput type="number" [value]="orderSignal()?.truck_weight_limit"
                (input)="onTruckWeightLimitChange($any($event.target).value)" [placeholder]="'INVOICE_UPLOAD.WEIGHT_LIMIT' | translate" min="0"
                step="1" />
              @if(!orderSignal()?.truck_weight_limit){
              <mat-error>{{ 'INVOICE_UPLOAD.WEIGHT_LIMIT_REQUIRED' | translate }}</mat-error>}
            </mat-form-field>
          </div>
        </div>
      </div>
    </div>

    <!-- Order Details Table -->
    <div class="logistics-card">
      <div class="section-header with-action">
        <div class="header-title">
          <mat-icon>list_alt</mat-icon>
          <h2>{{ 'INVOICE_UPLOAD.ORDER_DETAILS' | translate }}</h2>
        </div>
      </div>

      <app-generic-table [externalData]="orderDetailsSignal()" [columnTypes]="columnTypes"
        [externalTotalCount]="orderDetailsSignal().length" [displayedColumns]="displayedColumns"
        [nestedDisplayColumns]="nestedDisplayColumns" [parentId]="orderSignal()?.id " [useParentId]="true"
        [parentIdFieldName]="'order_id'" [title]="''" [showRowNumbers]="true" (addClick)="openOrderDetailAddDialog()"
        (externalDataUpdate)="updateOrderDetail($event)" (externalDataDelete)="deleteOrderDetail($event)"
        [excludeFields]="excludeFields" [showDeleteButton]="!hasPackages()" [showAddButton]="!hasPackages()"
        [showUpdateButton]="!hasPackages()">
      </app-generic-table>

      <div class="summary-footer">
        <div class="summary-content">
          <div class="summary-metrics">
            <div class="metric">
              <mat-icon>inventory_2</mat-icon>
              <span>{{ orderDetailsSignal().length }} {{'INVOICE_UPLOAD.ITEM' | translate}}</span>
            </div>
            <div class="metric">
              <mat-icon>scale</mat-icon>
              <span>{{ totalWeight().toFixed(2) }} kg</span>
            </div>
            <div class="metric">
              <mat-icon>straighten</mat-icon>
              <span>{{ totalMeter() }} m</span>
            </div>
            <div class="metric">
              <mat-icon>shopping_cart</mat-icon>
              <span>{{ totalCount() }} {{'INVOICE_UPLOAD.PRODUCTS_COUNT' | translate}}</span>
            </div>
          </div>
          <div class="status-badge">
            <span class="status-dot active"></span>
            <span>{{ 'COMMON.ACTIVE' | translate }}</span>
          </div>
        </div>
      </div>
    </div>
  </div>
  <!-- Navigation Controls -->
  <button mat-button class="next-button" (click)="submit()" [disabled]="!orderSignal() || !isFormValid()">
    <mat-icon>arrow_forward</mat-icon>
    <span>{{(isOrderDetailsDirtySignal() || isOrderDirtySignal() ? 'COMMON.SAVE' : 'COMMON.NEXT') | translate}}</span>
  </button>
  }



</div>

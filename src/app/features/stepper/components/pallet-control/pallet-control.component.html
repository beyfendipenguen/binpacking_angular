<form [formGroup]="secondFormGroup" style="padding-bottom:100px">
  <div class="logistics-header">
    <div class="header-icon">
      <mat-icon>inventory_2</mat-icon>
    </div>
    <div class="header-titles">
      <h1>{{ 'PALLET_CONTROL.TITLE' | translate }}</h1>
      <p class="header-subtitle">{{ 'PALLET_CONTROL.SUBTITLE' | translate }}</p>
    </div>
  </div>

  <div class="logistics-dashboard">
    <div class="dashboard-item">
      <div class="dashboard-icon">
        <mat-icon>view_in_ar</mat-icon>
      </div>
      <div class="dashboard-info">
        <span class="dashboard-label">{{ 'PALLET_CONTROL.REMAINING_SPACE' | translate }}</span>
        <span class="dashboard-value">{{ remainingArea() }} m²</span>
      </div>
    </div>

    <div class="dashboard-item">
      <div class="dashboard-icon">
        <mat-icon>scale</mat-icon>
      </div>
      <div class="dashboard-info">
        <span class="dashboard-label">{{ 'PALLET_CONTROL.TOTAL_WEIGHT' | translate }}</span>
        <span class="dashboard-value">{{ totalWeight() }} kg</span>
      </div>
    </div>

    <div class="dashboard-item">
      <div class="dashboard-icon">
        <mat-icon>fitness_center</mat-icon>
      </div>
      <div class="dashboard-info">
        <span class="dashboard-label">{{ 'PALLET_CONTROL.REMAINING_WEIGHT' | translate }}</span>
        <span class="dashboard-value">{{ remainingWeight() }} kg</span>
      </div>
    </div>

    <div class="dashboard-item">
      <div class="dashboard-icon">
        <mat-icon>straighten</mat-icon>
      </div>
      <div class="dashboard-info">
        <span class="dashboard-label">{{ 'PALLET_CONTROL.TOTAL_METER' | translate }}</span>
        <span class="dashboard-value">{{ totalMeter() }} m</span>
      </div>
    </div>
  </div>

  <div class="logistics-container">
    <!-- ÜRÜNLER BÖLÜMÜ -->
    <div class="inventory-section">
      <div class="section-header with-action">
        <div class="header-left">
          <mat-icon>category</mat-icon>
          <h2>{{ 'PALLET_CONTROL.INVENTORY' | translate }}</h2>
        </div>
        @if(remainingProducts().length > 0){
        <div class="header-actions">
          <button mat-icon-button class="header-action-button" (click)="toggleSort()" [matTooltip]="
                (sortAscending()
                  ? 'PALLET_CONTROL.SORT_ASC'
                  : 'PALLET_CONTROL.SORT_DESC') | translate
              ">
            <mat-icon [class.rotated]="sortAscending()">sort</mat-icon>
          </button>
          <button mat-icon-button class="header-action-button" [matTooltip]="'PALLET_CONTROL.MERGE_PRODUCTS' | translate" (click)="merge()">
            <mat-icon>merge</mat-icon>
          </button>
        </div>
        }
      </div>
      <div class="search-container">
        <div class="search-input-wrapper">
          <mat-icon class="search-icon">search</mat-icon>
          <input matInput class="search-input" type="text" [placeholder]="'PALLET_CONTROL.SEARCH_PRODUCT' | translate" [formControl]="searchControl"
            [matAutocomplete]="auto" id="searchControl" name="searchControl" />

          @if(searchControl.value) {
          <button mat-icon-button class="clear-search" (click)="clearSearch()" [matTooltip]="'COMMON.CLEAR_SEARCH' | translate">
            <mat-icon>close</mat-icon>
          </button>
          }

          <mat-autocomplete #auto="matAutocomplete" class="search-autocomplete"
            [displayWith]="displayProductFn.bind(this)">
            @if(isSearching) {
            <mat-option class="loading-indicator">
              <mat-spinner diameter="20"></mat-spinner>
              <span>{{ 'COMMON.SEARCHING' | translate }}</span>
            </mat-option>
            }

            @if(!isSearching) {
            @if(filteredProducts().length === 0) {
            <mat-option disabled>
              <mat-icon>search_off</mat-icon>
              <span>{{ 'PALLET.NO_RESULTS' | translate }}</span>
            </mat-option>
            }
            @for(product of filteredProducts(); track product.id) {
            <mat-option [value]="product" (click)="selectProduct(product)">
              <div class="product-option">
                <mat-icon>inventory</mat-icon>
                <span>{{ product.name }}</span>
              </div>
            </mat-option>
            }
            }
          </mat-autocomplete>
        </div>
      </div>

      <div cdkDropList #productsList="cdkDropList" id="productsList" [cdkDropListData]="remainingProducts()"
        [cdkDropListConnectedTo]="palletDropListIds()" class="inventory-list"
        (cdkDropListDropped)="dropPackageDetailToPackage($event)">
        @for(packageDetail of remainingProducts(); track packageDetail.id){
        <div class="product-item" cdkDrag (cdkDragStarted)="dragStarted($event)" (cdkDragEnded)="dragEnded()"
          [cdkDragData]="packageDetail">
          <div class="product-icon"></div>
          <div class="product-info">
            <span class="product-name">{{ packageDetail.product.name }}</span>
            <div class="product-count-container">
              <input matInput class="product-count-input" type="number" min="1" [value]="packageDetail.count"
                (keydown.enter)="$event.preventDefault()" inputmode="numeric"
                (focus)="$event.target.select()"
                (change)="updatePackageDetailCount(packageDetail, $event)" id="productCount-{{packageDetail.id}}"
                name="productCount-{{packageDetail.id}}" />
              <span class="count-label">{{ 'INVOICE_UPLOAD.TABLE.COUNT' | translate }}</span>
            </div>
          </div>

          <div class="split-product-container">
            <input class="mini-split-input" type="number" min="1" [max]="packageDetail.count - 1" placeholder="1"
              #splitInput (keydown.enter)="
                splitProduct(
                  packageDetail.id,
                  splitInput.value ? +splitInput.value : null
                );
                splitInput.value = ''
              " [matTooltip]="'PALLET_CONTROL.HOW_MANY_SPLIT'| translate" id="splitInput-{{packageDetail.id}}"
              name="splitInput-{{packageDetail.id}}" />

            <button mat-icon-button class="action-button split-button" (click)="
                splitProduct(
                  packageDetail.id,
                  splitInput.value ? +splitInput.value : null
                );
                splitInput.value = ''
              " [matTooltip]="'PALLET_CONTROL.SPLIT_PRODUCT'| translate">
              <mat-icon>content_cut</mat-icon>
            </button>
          </div>
          <div class="split-product-container">
            <button mat-icon-button class="action-button" (click)="deleteRemainingProducts([packageDetail.id])"
              [matTooltip]="'PALLET_CONTROL.DELETE_PRODUCT'| translate">
              <mat-icon>close</mat-icon>
            </button>
          </div>
        </div>
        } @if(!hasRemainingProduct()){
        <div class="empty-state">
          <mat-icon>done_all</mat-icon>
          <p>{{ 'PALLET_CONTROL.ALL_PRODUCTS_PLACED' | translate }}</p>
        </div>
        }
      </div>
    </div>

    <!-- PAKETLER BÖLÜMÜ -->
    <div class="packages-section">
      <div class="section-header with-action">
        <div class="header-content-inline">
          <div class="header-title-section">
            <mat-icon>view_quilt</mat-icon>
            <h2>{{ 'PALLET_CONTROL.PALLETIZING_AREA' | translate }}</h2>
            <button mat-raised-button (click)="calculatePackageDetail()" class="calculate-button"
              [matTooltip]="'PALLET_CONTROL.CALCULATE_PLACEMENT' | translate">
              <mat-icon>calculate</mat-icon>
              <span>{{ 'PALLET_CONTROL.CALCULATE' | translate }}</span>
            </button>

            @if(uiPackages().length > 0) {
            <mat-checkbox class="vertical-sort-checkbox" [checked]="verticalSortSignal()"
              (change)="onVerticalSortChange($event.checked)">{{ 'PALLET_CONTROL.VERTICAL_PLACEMENT' | translate }}</mat-checkbox>
            }
          </div>

          <!-- Palet İstatistikleri - Aynı satırda -->
          <div class="pallet-stats-inline">
            <div class="stat-item heaviest">
              <mat-icon>fitness_center</mat-icon>
              <div class="stat-info">
                <span class="stat-label">{{ 'PALLET_CONTROL.HEAVIEST' | translate }}</span>
                <span class="stat-value">{{ heaviestPalletWeight() }} kg</span>
              </div>
            </div>

            <div class="stat-item lightest">
              <mat-icon>feather</mat-icon>
              <div class="stat-info">
                <span class="stat-label">{{ 'PALLET_CONTROL.LIGHTEST' | translate }}</span>
                <span class="stat-value">{{ lightestPalletWeight() }} kg</span>
              </div>
            </div>

            <div class="stat-item average">
              <mat-icon>analytics</mat-icon>
              <div class="stat-info">
                <span class="stat-label">{{ 'PALLET_CONTROL.AVERAGE' | translate }}</span>
                <span class="stat-value">{{ averagePalletWeight() }} kg</span>
              </div>
            </div>
          </div>
        </div>

        <button mat-button class="clear-button" (click)="removeAllPackage()" [matTooltip]="'PALLET_CONTROL.CLEAR_ALL_PACKAGES' | translate">
          <mat-icon>delete_sweep</mat-icon>
          <span>{{ 'TRUCK_VISUALIZATION.CLEAR' | translate }}</span>
        </button>
      </div>

      <div class="packages-grid">
        @for(package of uiPackages(); track package.id){
        <div class="package-card" [class.remaining-package]="!package.is_remaining">
          <div class="package-header">
            <div class="package-title">
              <mat-icon>inbox</mat-icon>
              <span>Palet {{ package.name }}</span>
              @if(package.pallet?.dimension?.depth == 1000 || package.pallet?.dimension?.width == 1000){
              <button class="orientation-toggle" [class.vertical]="package.alignment === 'v'"
                (click)="toggleAlignment(package)"
                [matTooltip]="(package.alignment === 'v' ? 'PALLET_CONTROL.VERTICAL_LAYOUT' : 'PALLET_CONTROL.HORIZONTAL_LAYOUT') | translate">
                <div class="toggle-icon layers">
                  <span class="layer"></span>
                  <span class="layer"></span>
                  <span class="layer"></span>
                  <span class="layer"></span>
                </div>
              </button>
              }
            </div>
            <div class="package-actions">
              <button mat-icon-button class="small-action" [matTooltip]="'PALLET_CONTROL.REMOVE_PACKAGE' | translate" (click)="removePackage(package)">
                <mat-icon>close</mat-icon>
              </button>
            </div>
          </div>

          <!-- Paket içeriği -->
          <div cdkDropList [id]="package.id" [cdkDropListData]="[]" [cdkDropListConnectedTo]="['availablePalletsList']"
            class="package-dropzone" (cdkDropListDropped)="dropPalletToPackage($event)">
            <!-- Eğer paket içinde palet varsa göster -->
            @if(package.pallet){
            <div class="pallet-container">
              <div class="pallet-header">
                <div class="pallet-title">
                  <div class="pallet-icon"></div>
                  <span>{{ package.pallet.name }}</span>
                </div>
                <button mat-icon-button class="small-action" (click)="removePalletFromPackage(package)"
                  [matTooltip]="'PALLET_CONTROL.REMOVE_PACKAGE' | translate">
                  <mat-icon>close</mat-icon>
                </button>
              </div>

              <!-- Palet içindeki ürünler -->
              <div cdkDropList [id]="package.pallet.ui_id" [cdkDropListData]="package.package_details"
                [cdkDropListConnectedTo]="palletDropListIds()" class="pallet-content"
                (cdkDropListDropped)="dropPackageDetailToPackage($event)">
                @for(packageDetail of package.package_details;let j = $index; track
                packageDetail.id){

                <div class="pallet-item" cdkDrag [cdkDragData]="packageDetail" (cdkDragStarted)="dragStarted($event)"
                  (cdkDragEnded)="dragEnded()">
                  <div class="product-icon small"></div>
                  <div class="product-info">
                    <span class="product-name">{{ packageDetail.product.name }}</span>
                    <span class="product-count">{{ packageDetail.count }} {{'DIMENSIONS.QUANTITY' | translate}}</span>
                  </div>
                  <div class="button-container">
                    <button mat-icon-button class="action-button" (click)="addPackageDetail(packageDetail.id)"
                      [matTooltip]="'COMMON.ADD'| translate">
                      <mat-icon>add</mat-icon>
                    </button>
                    <button mat-icon-button class="action-button"
                      (click)="removePackageDetailFromPackage(package.id, j)" [matTooltip]="'COMMON.REMOVE_PRODUCT'| translate">
                      <mat-icon>close</mat-icon>
                    </button>
                  </div>
                </div>
                }
                <!-- Boş palet mesajı -->
                @if(package.package_details.length === 0){
                <div class="empty-state">
                  <mat-icon>drag_indicator</mat-icon>
                  <p>{{ 'PALLET_CONTROL.DRAG_PRODUCT_HERE' | translate }}</p>
                </div>
                }
              </div>

              <div class="pallet-footer">
                <div class="pallet-metrics">
                  <div class="metric">
                    <mat-icon>scale</mat-icon>
                    <span>{{ packageTotalWeight(package) }} kg</span>
                  </div>
                  <div class="metric">
                    <mat-icon>straighten</mat-icon>
                    <!-- <span>{{ package.totalMeter() }} m</span> -->
                  </div>
                  <div class="metric efficiency-metric">
                    <mat-icon>analytics</mat-icon>
                    <div class="efficiency-container">
                      <span class="efficiency-value">{{
                        getPalletFillPercentage(
                        package.pallet,
                        package.package_details
                        )
                        }}%</span>
                      <div class="efficiency-bar">
                        <div class="efficiency-fill" [style.width.%]="
                            getPalletFillPercentage(
                              package.pallet,
                              package.package_details
                            )
                          " [class.high-efficiency]="
                            getPalletFillPercentage(
                              package.pallet,
                              package.package_details
                            ) >= 80
                          " [class.medium-efficiency]="
                            getPalletFillPercentage(
                              package.pallet,
                              package.package_details
                            ) >= 50 &&
                            getPalletFillPercentage(
                              package.pallet,
                              package.package_details
                            ) < 80
                          " [class.low-efficiency]="
                            getPalletFillPercentage(
                              package.pallet,
                              package.package_details
                            ) < 50
                          "></div>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>
            }
            <!-- Boş paket mesajı -->
            @if(!package.pallet){
            <div class="empty-state">
              <mat-icon>add_box</mat-icon>
              <p>{{ 'PALLET_CONTROL.DRAG_PALLET' | translate }}</p>
            </div>
            }
          </div>
        </div>
        }
      </div>
    </div>

    <!-- PALETLER BÖLÜMÜ -->
    <div class="pallets-section">
      <div class="section-header">
        <mat-icon>view_module</mat-icon>
        <h2>{{ 'PALLET_CONTROL.PALLET_TYPES' | translate }}</h2>
      </div>

      <div cdkDropList #palletsList="cdkDropList" id="availablePalletsList" [cdkDropListData]="availablePallets()"
        [cdkDropListConnectedTo]="packageDropListIds()" class="pallets-list"
        (cdkDropListDropped)="dropPalletToPackage($event)">
        @for(pallet of availablePallets(); track pallet.ui_id){
        <div class="pallet-item" cdkDrag>
          <div class="pallet-base-icon"></div>
          <span class="pallet-name">{{ pallet.name }}</span>
        </div>
        } @if(availablePallets().length === 0){
        <div class="empty-state">
          <mat-icon>info</mat-icon>
          <p>{{ 'PALLET_CONTROL.NO_PALLETS' | translate }}</p>
        </div>
        }
      </div>
    </div>
  </div>


  <button mat-button class="next-button" (click)="submitForm()" [disabled]="!uiPackages() || uiPackages().length === 0">
    <mat-icon>arrow_forward</mat-icon>
    <span>{{( this.isDirtySignal() ? "'COMMON.SAVE'" : "'COMMON.SAVE'")| translate}}</span>
  </button>

  <button mat-button class="prev-button" (click)="goPreviousStep()">
    <mat-icon>arrow_back</mat-icon>
    <span>{{ 'COMMON.BACK' | translate }}</span>
  </button>

</form>

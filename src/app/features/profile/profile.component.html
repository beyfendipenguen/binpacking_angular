<div class="profile-container">
  <div class="profile-wrapper">
    <!-- Profile Header Section -->
    @if (!isLoading) {
      <div class="profile-header-card">
        <div class="cover-section">
          <div class="profile-picture-wrapper">
            <div class="profile-picture-container">
              <img
                [src]="profilePictureUrl"
                [alt]="'PROFILE.PHOTO' | translate"
                class="profile-picture"
                [class.loading]="isLoadingPicture"
              >
              @if (isLoadingPicture) {
                <div class="picture-overlay">
                  <mat-spinner diameter="30"></mat-spinner>
                </div>
              }
              <button
                mat-mini-fab
                class="upload-button"
                (click)="fileInput.click()"
                [disabled]="isLoading"
              >
                <mat-icon>photo_camera</mat-icon>
              </button>
              <input
                #fileInput
                type="file"
                accept="image/*"
                (change)="onFileSelected($event)"
                style="display: none"
              >
            </div>
          </div>

          <div class="profile-info">
            <h1 class="profile-name">
              {{userProfile?.first_name}} {{userProfile?.last_name}}
              @if (userProfile?.is_admin) {
                <span class="admin-badge">{{ 'PROFILE.ADMIN' | translate }}</span>
              }
            </h1>
            <p class="profile-email">{{userProfile?.email}}</p>
            @if (userProfile?.username) {
              <p class="profile-username">{{userProfile?.username}}</p>
            }
          </div>
        </div>
      </div>
    }

    <!-- Loading Skeleton for Header -->
    @if (isLoading) {
      <div class="profile-header-card">
        <div class="cover-section">
          <div class="profile-picture-wrapper">
            <div class="profile-picture-container">
              <div class="profile-picture skeleton"></div>
            </div>
          </div>
          <div class="profile-info">
            <div class="skeleton-text title"></div>
            <div class="skeleton-text subtitle"></div>
          </div>
        </div>
      </div>
    }

    <!-- Tabs Section -->
    <mat-card class="profile-content-card">
      <mat-tab-group animationDuration="500ms" class="profile-tabs">
        <!-- Personal Information Tab -->
        <mat-tab>
          <ng-template mat-tab-label>
            <mat-icon class="tab-icon">person</mat-icon>
            <span>{{ 'PROFILE.PERSONAL_INFO' | translate }}</span>
          </ng-template>

          <div class="tab-content">
            <form [formGroup]="profileForm" (ngSubmit)="onUpdateProfile()" class="profile-form">
              <div class="form-section">
                <h3 class="section-title">{{ 'PROFILE.BASIC_INFO' | translate }}</h3>

                <div class="form-row">
                  <mat-form-field appearance="outline" class="form-field">
                    <mat-label>{{ 'COMMON.NAME' | translate }}</mat-label>
                    <input matInput formControlName="first_name" [placeholder]="'PROFILE.NAME_PLACEHOLDER' | translate">
                    <mat-icon matSuffix>person</mat-icon>
                    @if (profileForm.get('first_name')?.hasError('required')) {
                      <mat-error>{{ 'PROFILE.NAME_REQUIRED' | translate }}</mat-error>
                    }
                  </mat-form-field>

                  <mat-form-field appearance="outline" class="form-field">
                    <mat-label>{{ 'COMMON.SURNAME' | translate }}</mat-label>
                    <input matInput formControlName="last_name" [placeholder]="'PROFILE.SURNAME_PLACEHOLDER' | translate">
                    <mat-icon matSuffix>person</mat-icon>
                    @if (profileForm.get('last_name')?.hasError('required')) {
                      <mat-error>{{ 'PROFILE.SURNAME_REQUIRED' | translate }}</mat-error>
                    }
                  </mat-form-field>
                </div>

                <div class="form-row">
                  <mat-form-field appearance="outline" class="form-field">
                    <mat-label>{{ 'SIGNIN.USERNAME_LABEL' | translate }}</mat-label>
                    <input matInput formControlName="username" [placeholder]="'PROFILE.USERNAME_PLACEHOLDER' | translate">
                    <mat-icon matSuffix>alternate_email</mat-icon>
                    @if (profileForm.get('username')?.hasError('required')) {
                      <mat-error>{{ 'PROFILE.USERNAME_REQUIRED' | translate }}</mat-error>
                    }
                  </mat-form-field>

                  <mat-form-field appearance="outline" class="form-field">
                    <mat-label>{{ 'COMMON.EMAIL' | translate }}</mat-label>
                    <input matInput formControlName="email" type="email" [placeholder]="'AUTH.ENTER_EMAIL' | translate">
                    <mat-icon matSuffix>email</mat-icon>
                    @if (profileForm.get('email')?.hasError('required')) {
                      <mat-error>{{ 'PROFILE.EMAIL_REQUIRED' | translate }}</mat-error>
                    }
                    @if (profileForm.get('email')?.hasError('email')) {
                      <mat-error>{{ 'AUTH.VALID_EMAIL' | translate }}</mat-error>
                    }
                  </mat-form-field>
                </div>
              </div>

              <mat-divider></mat-divider>

              <div class="form-section">
                <h3 class="section-title">{{ 'PROFILE.CONTACT_INFO' | translate }}</h3>

                <div class="form-row">
                  <mat-form-field appearance="outline" class="form-field country-code">
                    <mat-label>{{ 'PROFILE.COUNTRY_CODE' | translate }}</mat-label>
                    <mat-select formControlName="countryCode">
                      @for (country of countryCodes; track country.code) {
                        <mat-option [value]="country.code">
                          {{country.country}} ({{country.code}})
                        </mat-option>
                      }
                    </mat-select>
                    <mat-icon matSuffix>public</mat-icon>
                  </mat-form-field>

                  <mat-form-field appearance="outline" class="form-field phone-number">
                    <mat-label>{{ 'PROFILE.PHONE_NUMBER' | translate }}</mat-label>
                    <input matInput formControlName="phone" placeholder="5XX XXX XX XX"
                          (input)="onPhoneInput($event)" maxlength="13">
                    <mat-icon matSuffix>phone</mat-icon>
                    <mat-hint>{{ 'PROFILE.PHONE_PLACEHOLDER' | translate }}</mat-hint>
                    @if (profileForm.get('phone')?.hasError('pattern')) {
                      <mat-error>{{ 'PROFILE.PHONE_NUMBERS_ONLY' | translate }}</mat-error>
                    }
                  </mat-form-field>
                </div>

                <mat-form-field appearance="outline" class="form-field full-width">
                  <mat-label>{{ 'COMMON.ADDRESS' | translate }}</mat-label>
                  <textarea matInput formControlName="address" rows="3" [placeholder]="'PROFILE.ADDRESS_PLACEHOLDER' | translate"></textarea>
                  <mat-icon matSuffix>location_on</mat-icon>
                </mat-form-field>
              </div>

              <div class="form-actions">
                <button
                  mat-raised-button
                  color="primary"
                  type="submit"
                  [disabled]="isLoading || profileForm.invalid  || !formChanged "
                  class="submit-button"
                >
                  @if (!isLoading) {
                    <span>{{ 'PROFILE.UPDATE_PROFILE' | translate }}</span>
                  }
                </button>

                <button
                  mat-stroked-button
                  type="button"
                  (click)="resetForm()"
                  [disabled]="isLoading"
                  class="cancel-button"
                >{{ 'PROFILE.RESET' | translate }}</button>
              </div>
            </form>
          </div>
        </mat-tab>

        <!-- Company Information Tab -->
        <mat-tab>
          <ng-template mat-tab-label>
            <mat-icon class="tab-icon">business</mat-icon>
            <span>{{ 'PROFILE.COMPANY_INFO' | translate }}</span>
          </ng-template>

          <div class="tab-content">
            @if (userCompany) {
              <form [formGroup]="companyForm" (ngSubmit)="onUpdateCompany()" class="profile-form">

                <!-- Company Logo Section -->
                <div class="form-section">
                  <h3 class="section-title">{{ 'PROFILE.COMPANY_LOGO' | translate }}</h3>

                  <div class="company-logo-section">
                    <div class="company-logo-container">
                      <img
                        [src]="companyLogoUrl"
                        [alt]="'PROFILE.LOGO_ALT' | translate"
                        class="company-logo"
                        [class.loading]="isLoadingCompanyLogo"
                      >
                      @if (isLoadingCompanyLogo) {
                        <div class="logo-overlay">
                          <mat-spinner diameter="30"></mat-spinner>
                        </div>
                      }
                      <button
                        mat-mini-fab
                        class="upload-button"
                        (click)="companyLogoInput.click()"
                        [disabled]="isSavingCompany"
                        type="button"
                      >
                        <mat-icon>photo_camera</mat-icon>
                      </button>
                      <input
                        #companyLogoInput
                        type="file"
                        accept="image/*"
                        (change)="onCompanyLogoSelected($event)"
                        style="display: none"
                      >
                    </div>
                    <div class="company-logo-info">
                      <p class="info-text">{{ 'PROFILE.UPLOAD_LOGO' | translate }}</p>
                      <p class="hint-text">{{ 'PROFILE.LOGO_SIZE_TIP' | translate }}</p>
                    </div>
                  </div>
                </div>

                <mat-divider></mat-divider>

                <!-- Company Details Section -->
                <div class="form-section">
                  <h3 class="section-title">{{ 'PROFILE.COMPANY_DETAILS' | translate }}</h3>

                  <mat-form-field appearance="outline" class="form-field full-width">
                    <mat-label>{{ 'CUSTOMER.COMPANY_NAME' | translate }}</mat-label>
                    <input matInput formControlName="company_name" [placeholder]="'PROFILE.COMPANY_NAME_PLACEHOLDER' | translate">
                    <mat-icon matSuffix>business</mat-icon>
                    @if (companyForm.get('company_name')?.hasError('required')) {
                      <mat-error>{{ 'PROFILE.COMPANY_NAME_REQUIRED' | translate }}</mat-error>
                    }
                    @if (companyForm.get('company_name')?.hasError('minlength')) {
                      <mat-error>{{ 'PROFILE.COMPANY_NAME_MIN' | translate }}</mat-error>
                    }
                  </mat-form-field>

                  <mat-form-field appearance="outline" class="form-field full-width">
                    <mat-label>{{ 'COMMON.COUNTRY' | translate }}</mat-label>
                    <input matInput formControlName="country" [placeholder]="'PROFILE.COUNTRY_PLACEHOLDER' | translate">
                    <mat-icon matSuffix>flag</mat-icon>
                    @if (companyForm.get('country')?.hasError('required')) {
                      <mat-error>{{ 'PROFILE.COUNTRY_REQUIRED' | translate }}</mat-error>
                    }
                    @if (companyForm.get('country')?.hasError('minlength')) {
                      <mat-error>{{ 'PROFILE.COUNTRY_MIN' | translate }}</mat-error>
                    }
                  </mat-form-field>
                </div>

                <div class="form-actions">
                  <button
                    mat-raised-button
                    color="primary"
                    type="submit"
                    [disabled]="isSavingCompany || companyForm.invalid || !companyFormChanged"
                    class="submit-button"
                  >
                    @if (!isSavingCompany) {
                      <span>{{ 'PROFILE.UPDATE_COMPANY' | translate }}</span>
                    }
                  </button>

                  <button
                    mat-stroked-button
                    type="button"
                    (click)="resetCompanyForm()"
                    [disabled]="isSavingCompany"
                    class="cancel-button"
                  >{{ 'PROFILE.RESET' | translate }}</button>
                </div>
              </form>
            } @else {
              <div class="no-company-section">
                <mat-icon class="large-icon">business_center</mat-icon>
                <h3>{{ 'PROFILE.NO_COMPANY' | translate }}</h3>
                <p>{{ 'PROFILE.NO_COMPANY_ASSIGNED' | translate }}</p>
              </div>
            }
          </div>
        </mat-tab>

        <!-- Change Password Tab -->
        <mat-tab>
          <ng-template mat-tab-label>
            <mat-icon class="tab-icon">lock</mat-icon>
            <span>{{ 'PROFILE.SECURITY' | translate }}</span>
          </ng-template>

          <div class="tab-content">
            <form [formGroup]="passwordForm" (ngSubmit)="onChangePassword()" class="profile-form">
              <div class="form-section">
                <h3 class="section-title">{{ 'PROFILE.CHANGE_PASSWORD' | translate }}</h3>

                <mat-form-field appearance="outline" class="form-field full-width">
                  <mat-label>{{ 'AUTH.CURRENT_PASSWORD' | translate }}</mat-label>
                  <input matInput [type]="hidePassword ? 'password' : 'text'" formControlName="old_password">
                  <button mat-icon-button matSuffix (click)="hidePassword = !hidePassword" [attr.aria-label]="'AUTH.HIDE_PASSWORD' | translate" [attr.aria-pressed]="hidePassword" type="button">
                    <mat-icon>{{hidePassword ? 'visibility_off' : 'visibility'}}</mat-icon>
                  </button>
                  @if (passwordForm.get('old_password')?.hasError('required')) {
                    <mat-error>{{ 'AUTH.CURRENT_PASSWORD_REQUIRED' | translate }}</mat-error>
                  }
                </mat-form-field>

                <mat-form-field appearance="outline" class="form-field full-width">
                  <mat-label>{{ 'AUTH.NEW_PASSWORD' | translate }}</mat-label>
                  <input matInput [type]="hideNewPassword ? 'password' : 'text'" formControlName="new_password">
                  <button mat-icon-button matSuffix (click)="hideNewPassword = !hideNewPassword" [attr.aria-label]="'AUTH.HIDE_PASSWORD' | translate" [attr.aria-pressed]="hideNewPassword" type="button">
                    <mat-icon>{{hideNewPassword ? 'visibility_off' : 'visibility'}}</mat-icon>
                  </button>
                  @if (passwordForm.get('new_password')?.hasError('required')) {
                    <mat-error>{{ 'AUTH.NEW_PASSWORD_REQUIRED' | translate }}</mat-error>
                  }
                  @if (passwordForm.get('new_password')?.hasError('minlength')) {
                    <mat-error>{{ 'AUTH.PASSWORD_MIN_LENGTH' | translate }}</mat-error>
                  }
                </mat-form-field>

                <mat-form-field appearance="outline" class="form-field full-width">
                  <mat-label>{{ 'AUTH.CONFIRM_NEW_PASSWORD' | translate }}</mat-label>
                  <input matInput [type]="hideConfirmPassword ? 'password' : 'text'" formControlName="confirm_password">
                  <button mat-icon-button matSuffix (click)="hideConfirmPassword = !hideConfirmPassword" [attr.aria-label]="'AUTH.HIDE_PASSWORD' | translate" [attr.aria-pressed]="hideConfirmPassword" type="button">
                    <mat-icon>{{hideConfirmPassword ? 'visibility_off' : 'visibility'}}</mat-icon>
                  </button>
                  @if (passwordForm.get('confirm_password')?.hasError('required')) {
                    <mat-error>{{ 'PROFILE.CONFIRM_PASSWORD_PLACEHOLDER' | translate }}</mat-error>
                  }
                  @if (passwordForm.hasError('mismatch') && !passwordForm.get('confirm_password')?.hasError('required')) {
                    <mat-error>{{ 'AUTH.PASSWORD_MISMATCH' | translate }}</mat-error>
                  }
                </mat-form-field>
              </div>

              <div class="password-strength">
                <div class="strength-indicator" [class.weak]="getPasswordStrength() === 'weak'"
                     [class.medium]="getPasswordStrength() === 'medium'"
                     [class.strong]="getPasswordStrength() === 'strong'">
                  <span>Parola gücü: {{getPasswordStrength()}}</span>
                </div>
              </div>

              <div class="form-actions">
                <button
                  mat-raised-button
                  color="primary"
                  type="submit"
                  [disabled]="isLoading || passwordForm.invalid"
                  class="submit-button"
                >
                  @if (!isLoading) {
                    <span>{{'PASSWORD.CHANGE_PASSWORD' | translate}}</span>
                  }
                </button>

                <button
                  mat-stroked-button
                  type="button"
                  (click)="passwordForm.reset()"
                  [disabled]="isLoading"
                  class="cancel-button"
                >{{ 'TRUCK_VISUALIZATION.CLEAR' | translate }}</button>
              </div>
            </form>

            <!-- Parolamı Unuttum linkleri -->
            <div class="forgot-password-section">
              <mat-divider></mat-divider>
              <p class="forgot-text">{{ 'PASSWORD.FORGOT_PASSWORD_QUESTION' | translate }}</p>
              <button
                mat-stroked-button
                color="accent"
                class="forgot-button"
                (click)="openForgotPasswordDialog()"
              >
                <mat-icon>lock_reset</mat-icon>{{ 'AUTH.FORGOT_PASSWORD' | translate }}</button>
            </div>
          </div>
        </mat-tab>

        <!-- Account Settings Tab -->
        <mat-tab>
          <ng-template mat-tab-label>
            <mat-icon class="tab-icon">settings</mat-icon>
            <span>{{ 'PROFILE.SETTINGS' | translate }}</span>
          </ng-template>

          <div class="tab-content">
            <div class="settings-section">
              <h3 class="section-title">{{ 'PROFILE.ACCOUNT_INFO' | translate }}</h3>

              <div class="info-card">
                <div class="info-item">
                  <mat-icon>verified_user</mat-icon>
                  <div>
                    <p class="info-label">{{ 'PROFILE.ACCOUNT_TYPE' | translate }}</p>
                    <p class="info-value">{{(userProfile?.is_admin ? 'PROFILE.ADMIN' : 'PROFILE.NORMAL_USER') | translate}}</p>
                  </div>
                </div>

                @if (userProfile?.company) {
                  <div class="info-item">
                    <mat-icon>business</mat-icon>
                    <div>
                      <p class="info-label">{{ 'PROFILE.COMPANY' | translate }}</p>
                      <p class="info-value">{{userCompany?.company_name || 'INFO.FILE_UPLOADING' | translate}}</p>
                    </div>
                  </div>
                }

                <div class="info-item">
                  <mat-icon>fingerprint</mat-icon>
                  <div>
                    <p class="info-label">{{ 'PROFILE.USER_ID' | translate }}</p>
                    <p class="info-value">{{userProfile?.id}}</p>
                  </div>
                </div>
              </div>
            </div>

            <div class="settings-section">
              <h3 class="section-title">{{ 'PROFILE.DANGER_ZONE' | translate }}</h3>
              <div class="danger-zone">
                <button mat-stroked-button color="warn" class="danger-button">
                  <mat-icon>delete_forever</mat-icon>{{ 'PROFILE.DELETE_ACCOUNT' | translate }}</button>
              </div>
            </div>
          </div>
        </mat-tab>
      </mat-tab-group>
    </mat-card>
  </div>
</div>

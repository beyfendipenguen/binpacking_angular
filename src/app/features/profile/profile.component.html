<div class="profile-container">
  <div class="profile-wrapper">
    <!-- Profile Header Section -->
    @if (!isLoading) {
      <div class="profile-header-card">
        <div class="cover-section">
          <div class="profile-picture-wrapper">
            <div class="profile-picture-container">
              <img
                [src]="profilePictureUrl"
                alt="Profil fotoğrafı"
                class="profile-picture"
                [class.loading]="isLoadingPicture"
              >
              @if (isLoadingPicture) {
                <div class="picture-overlay">
                  <mat-spinner diameter="30"></mat-spinner>
                </div>
              }
              <button
                mat-mini-fab
                class="upload-button"
                (click)="fileInput.click()"
                [disabled]="isLoading"
              >
                <mat-icon>photo_camera</mat-icon>
              </button>
              <input
                #fileInput
                type="file"
                accept="image/*"
                (change)="onFileSelected($event)"
                style="display: none"
              >
            </div>
          </div>

          <div class="profile-info">
            <h1 class="profile-name">
              {{userProfile?.first_name}} {{userProfile?.last_name}}
              @if (userProfile?.is_admin) {
                <span class="admin-badge">Yönetici</span>
              }
            </h1>
            <p class="profile-email">{{userProfile?.email}}</p>
            @if (userProfile?.username) {
              <p class="profile-username">{{userProfile?.username}}</p>
            }
          </div>
        </div>
      </div>
    }

    <!-- Loading Skeleton for Header -->
    @if (isLoading) {
      <div class="profile-header-card">
        <div class="cover-section">
          <div class="profile-picture-wrapper">
            <div class="profile-picture-container">
              <div class="profile-picture skeleton"></div>
            </div>
          </div>
          <div class="profile-info">
            <div class="skeleton-text title"></div>
            <div class="skeleton-text subtitle"></div>
          </div>
        </div>
      </div>
    }

    <!-- Tabs Section -->
    <mat-card class="profile-content-card">
      <mat-tab-group animationDuration="500ms" class="profile-tabs">
        <!-- Personal Information Tab -->
        <mat-tab>
          <ng-template mat-tab-label>
            <mat-icon class="tab-icon">person</mat-icon>
            <span>Kişisel Bilgiler</span>
          </ng-template>

          <div class="tab-content">
            <form [formGroup]="profileForm" (ngSubmit)="onUpdateProfile()" class="profile-form">
              <div class="form-section">
                <h3 class="section-title">Temel Bilgiler</h3>

                <div class="form-row">
                  <mat-form-field appearance="outline" class="form-field">
                    <mat-label>Ad</mat-label>
                    <input matInput formControlName="first_name" placeholder="Adınızı girin">
                    <mat-icon matSuffix>person</mat-icon>
                    @if (profileForm.get('first_name')?.hasError('required')) {
                      <mat-error>Ad alanı zorunludur</mat-error>
                    }
                  </mat-form-field>

                  <mat-form-field appearance="outline" class="form-field">
                    <mat-label>Soyad</mat-label>
                    <input matInput formControlName="last_name" placeholder="Soyadınızı girin">
                    <mat-icon matSuffix>person</mat-icon>
                    @if (profileForm.get('last_name')?.hasError('required')) {
                      <mat-error>Soyad alanı zorunludur</mat-error>
                    }
                  </mat-form-field>
                </div>

                <div class="form-row">
                  <mat-form-field appearance="outline" class="form-field">
                    <mat-label>Kullanıcı Adı</mat-label>
                    <input matInput formControlName="username" placeholder="Kullanıcı adınızı girin">
                    <mat-icon matSuffix>alternate_email</mat-icon>
                    @if (profileForm.get('username')?.hasError('required')) {
                      <mat-error>Kullanıcı adı zorunludur</mat-error>
                    }
                  </mat-form-field>

                  <mat-form-field appearance="outline" class="form-field">
                    <mat-label>E-posta</mat-label>
                    <input matInput formControlName="email" type="email" placeholder="E-posta adresinizi girin">
                    <mat-icon matSuffix>email</mat-icon>
                    @if (profileForm.get('email')?.hasError('required')) {
                      <mat-error>E-posta alanı zorunludur</mat-error>
                    }
                    @if (profileForm.get('email')?.hasError('email')) {
                      <mat-error>Geçerli bir e-posta adresi girin</mat-error>
                    }
                  </mat-form-field>
                </div>
              </div>

              <mat-divider></mat-divider>

              <div class="form-section">
                <h3 class="section-title">İletişim Bilgileri</h3>

                <div class="form-row">
                  <mat-form-field appearance="outline" class="form-field country-code">
                    <mat-label>Ülke Kodu</mat-label>
                    <mat-select formControlName="countryCode">
                      @for (country of countryCodes; track country.code) {
                        <mat-option [value]="country.code">
                          {{country.country}} ({{country.code}})
                        </mat-option>
                      }
                    </mat-select>
                    <mat-icon matSuffix>public</mat-icon>
                  </mat-form-field>

                  <mat-form-field appearance="outline" class="form-field phone-number">
                    <mat-label>Telefon Numarası</mat-label>
                    <input matInput formControlName="phone" placeholder="5XX XXX XX XX"
                          (input)="onPhoneInput($event)" maxlength="13">
                    <mat-icon matSuffix>phone</mat-icon>
                    <mat-hint>Başında 0 olmadan girin</mat-hint>
                    @if (profileForm.get('phone')?.hasError('pattern')) {
                      <mat-error>Sadece rakam girebilirsiniz</mat-error>
                    }
                  </mat-form-field>
                </div>

                <mat-form-field appearance="outline" class="form-field full-width">
                  <mat-label>Adres</mat-label>
                  <textarea matInput formControlName="address" rows="3" placeholder="Adresinizi girin"></textarea>
                  <mat-icon matSuffix>location_on</mat-icon>
                </mat-form-field>
              </div>

              <div class="form-actions">
                <button
                  mat-raised-button
                  color="primary"
                  type="submit"
                  [disabled]="isLoading || profileForm.invalid  || !formChanged "
                  class="submit-button"
                >
                  @if (!isLoading) {
                    <span>Profili Güncelle</span>
                  }
                </button>

                <button
                  mat-stroked-button
                  type="button"
                  (click)="resetForm()"
                  [disabled]="isLoading"
                  class="cancel-button"
                >
                  Sıfırla
                </button>
              </div>
            </form>
          </div>
        </mat-tab>

        <!-- Company Information Tab -->
        <mat-tab>
          <ng-template mat-tab-label>
            <mat-icon class="tab-icon">business</mat-icon>
            <span>Şirket Bilgileri</span>
          </ng-template>

          <div class="tab-content">
            @if (userCompany) {
              <form [formGroup]="companyForm" (ngSubmit)="onUpdateCompany()" class="profile-form">

                <!-- Company Logo Section -->
                <div class="form-section">
                  <h3 class="section-title">Şirket Logosu</h3>

                  <div class="company-logo-section">
                    <div class="company-logo-container">
                      <img
                        [src]="companyLogoUrl"
                        alt="Şirket logosu"
                        class="company-logo"
                        [class.loading]="isLoadingCompanyLogo"
                      >
                      @if (isLoadingCompanyLogo) {
                        <div class="logo-overlay">
                          <mat-spinner diameter="30"></mat-spinner>
                        </div>
                      }
                      <button
                        mat-mini-fab
                        class="upload-button"
                        (click)="companyLogoInput.click()"
                        [disabled]="isSavingCompany"
                        type="button"
                      >
                        <mat-icon>photo_camera</mat-icon>
                      </button>
                      <input
                        #companyLogoInput
                        type="file"
                        accept="image/*"
                        (change)="onCompanyLogoSelected($event)"
                        style="display: none"
                      >
                    </div>
                    <div class="company-logo-info">
                      <p class="info-text">Şirket logonuzu yükleyin veya değiştirin</p>
                      <p class="hint-text">Önerilen boyut: 512x512px, maksimum 2MB</p>
                    </div>
                  </div>
                </div>

                <mat-divider></mat-divider>

                <!-- Company Details Section -->
                <div class="form-section">
                  <h3 class="section-title">Şirket Detayları</h3>

                  <mat-form-field appearance="outline" class="form-field full-width">
                    <mat-label>Şirket Adı</mat-label>
                    <input matInput formControlName="company_name" placeholder="Şirket adını girin">
                    <mat-icon matSuffix>business</mat-icon>
                    @if (companyForm.get('company_name')?.hasError('required')) {
                      <mat-error>Şirket adı zorunludur</mat-error>
                    }
                    @if (companyForm.get('company_name')?.hasError('minlength')) {
                      <mat-error>Şirket adı en az 2 karakter olmalıdır</mat-error>
                    }
                  </mat-form-field>

                  <mat-form-field appearance="outline" class="form-field full-width">
                    <mat-label>Ülke</mat-label>
                    <input matInput formControlName="country" placeholder="Ülke adını girin">
                    <mat-icon matSuffix>flag</mat-icon>
                    @if (companyForm.get('country')?.hasError('required')) {
                      <mat-error>Ülke zorunludur</mat-error>
                    }
                    @if (companyForm.get('country')?.hasError('minlength')) {
                      <mat-error>Ülke en az 2 karakter olmalıdır</mat-error>
                    }
                  </mat-form-field>
                </div>

                <div class="form-actions">
                  <button
                    mat-raised-button
                    color="primary"
                    type="submit"
                    [disabled]="isSavingCompany || companyForm.invalid || !companyFormChanged"
                    class="submit-button"
                  >
                    @if (!isSavingCompany) {
                      <span>Şirket Bilgilerini Güncelle</span>
                    }
                  </button>

                  <button
                    mat-stroked-button
                    type="button"
                    (click)="resetCompanyForm()"
                    [disabled]="isSavingCompany"
                    class="cancel-button"
                  >
                    Sıfırla
                  </button>
                </div>
              </form>
            } @else {
              <div class="no-company-section">
                <mat-icon class="large-icon">business_center</mat-icon>
                <h3>Şirket Bilgisi Bulunamadı</h3>
                <p>Hesabınıza henüz bir şirket atanmamış.</p>
              </div>
            }
          </div>
        </mat-tab>

        <!-- Change Password Tab -->
        <mat-tab>
          <ng-template mat-tab-label>
            <mat-icon class="tab-icon">lock</mat-icon>
            <span>Güvenlik</span>
          </ng-template>

          <div class="tab-content">
            <form [formGroup]="passwordForm" (ngSubmit)="onChangePassword()" class="profile-form">
              <div class="form-section">
                <h3 class="section-title">Parola Değiştir</h3>

                <mat-form-field appearance="outline" class="form-field full-width">
                  <mat-label>Mevcut Parola</mat-label>
                  <input matInput [type]="hidePassword ? 'password' : 'text'" formControlName="old_password">
                  <button mat-icon-button matSuffix (click)="hidePassword = !hidePassword" [attr.aria-label]="'Parolayı gizle'" [attr.aria-pressed]="hidePassword" type="button">
                    <mat-icon>{{hidePassword ? 'visibility_off' : 'visibility'}}</mat-icon>
                  </button>
                  @if (passwordForm.get('old_password')?.hasError('required')) {
                    <mat-error>Mevcut parola zorunludur</mat-error>
                  }
                </mat-form-field>

                <mat-form-field appearance="outline" class="form-field full-width">
                  <mat-label>Yeni Parola</mat-label>
                  <input matInput [type]="hideNewPassword ? 'password' : 'text'" formControlName="new_password">
                  <button mat-icon-button matSuffix (click)="hideNewPassword = !hideNewPassword" [attr.aria-label]="'Parolayı gizle'" [attr.aria-pressed]="hideNewPassword" type="button">
                    <mat-icon>{{hideNewPassword ? 'visibility_off' : 'visibility'}}</mat-icon>
                  </button>
                  @if (passwordForm.get('new_password')?.hasError('required')) {
                    <mat-error>Yeni parola zorunludur</mat-error>
                  }
                  @if (passwordForm.get('new_password')?.hasError('minlength')) {
                    <mat-error>Parola en az 8 karakter olmalıdır</mat-error>
                  }
                </mat-form-field>

                <mat-form-field appearance="outline" class="form-field full-width">
                  <mat-label>Yeni Parolayı Onayla</mat-label>
                  <input matInput [type]="hideConfirmPassword ? 'password' : 'text'" formControlName="confirm_password">
                  <button mat-icon-button matSuffix (click)="hideConfirmPassword = !hideConfirmPassword" [attr.aria-label]="'Parolayı gizle'" [attr.aria-pressed]="hideConfirmPassword" type="button">
                    <mat-icon>{{hideConfirmPassword ? 'visibility_off' : 'visibility'}}</mat-icon>
                  </button>
                  @if (passwordForm.get('confirm_password')?.hasError('required')) {
                    <mat-error>Lütfen parolanızı onaylayın</mat-error>
                  }
                  @if (passwordForm.hasError('mismatch') && !passwordForm.get('confirm_password')?.hasError('required')) {
                    <mat-error>Parolalar eşleşmiyor</mat-error>
                  }
                </mat-form-field>
              </div>

              <div class="password-strength">
                <div class="strength-indicator" [class.weak]="getPasswordStrength() === 'weak'"
                     [class.medium]="getPasswordStrength() === 'medium'"
                     [class.strong]="getPasswordStrength() === 'strong'">
                  <span>Parola gücü: {{getPasswordStrength()}}</span>
                </div>
              </div>

              <div class="form-actions">
                <button
                  mat-raised-button
                  color="primary"
                  type="submit"
                  [disabled]="isLoading || passwordForm.invalid"
                  class="submit-button"
                >
                  @if (!isLoading) {
                    <span>Parolayı Değiştir</span>
                  }
                </button>

                <button
                  mat-stroked-button
                  type="button"
                  (click)="passwordForm.reset()"
                  [disabled]="isLoading"
                  class="cancel-button"
                >
                  Temizle
                </button>
              </div>
            </form>

            <!-- Parolamı Unuttum linkleri -->
            <div class="forgot-password-section">
              <mat-divider></mat-divider>
              <p class="forgot-text">Parolanızı mi unuttunuz?</p>
              <button
                mat-stroked-button
                color="accent"
                class="forgot-button"
                (click)="openForgotPasswordDialog()"
              >
                <mat-icon>lock_reset</mat-icon>
                Parolamı Unuttum
              </button>
            </div>
          </div>
        </mat-tab>

        <!-- Account Settings Tab -->
        <mat-tab>
          <ng-template mat-tab-label>
            <mat-icon class="tab-icon">settings</mat-icon>
            <span>Ayarlar</span>
          </ng-template>

          <div class="tab-content">
            <div class="settings-section">
              <h3 class="section-title">Hesap Bilgileri</h3>

              <div class="info-card">
                <div class="info-item">
                  <mat-icon>verified_user</mat-icon>
                  <div>
                    <p class="info-label">Hesap Türü</p>
                    <p class="info-value">{{userProfile?.is_admin ? 'Yönetici' : 'Normal Kullanıcı'}}</p>
                  </div>
                </div>

                @if (userProfile?.company) {
                  <div class="info-item">
                    <mat-icon>business</mat-icon>
                    <div>
                      <p class="info-label">Şirket</p>
                      <p class="info-value">{{userCompany?.company_name || 'Yükleniyor...'}}</p>
                    </div>
                  </div>
                }

                <div class="info-item">
                  <mat-icon>fingerprint</mat-icon>
                  <div>
                    <p class="info-label">Kullanıcı ID</p>
                    <p class="info-value">{{userProfile?.id}}</p>
                  </div>
                </div>
              </div>
            </div>

            <div class="settings-section">
              <h3 class="section-title">Tehlikeli Bölge</h3>
              <div class="danger-zone">
                <button mat-stroked-button color="warn" class="danger-button">
                  <mat-icon>delete_forever</mat-icon>
                  Hesabı Sil
                </button>
              </div>
            </div>
          </div>
        </mat-tab>
      </mat-tab-group>
    </mat-card>
  </div>
</div>
